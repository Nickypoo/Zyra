<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RateLimitedRequester.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">zyra</a> &gt; <a href="index.source.html" class="el_package">com.mingweisamuel.zyra.util</a> &gt; <span class="el_source">RateLimitedRequester.java</span></div><h1>RateLimitedRequester.java</h1><pre class="source lang-java linenums">package com.mingweisamuel.zyra.util;

import com.mingweisamuel.zyra.ResponseListener;
import com.mingweisamuel.zyra.enums.Region;
import org.asynchttpclient.AsyncHttpClient;
import org.asynchttpclient.Param;
import org.asynchttpclient.Response;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

/**
 * For sending rate-limited requests to the Riot API.
 */
public class RateLimitedRequester extends Requester {

    /** Default retries. */
    public static final int RETRIES_DEFAULT = 3;

    /** Root url for Riot API requests. */
    private static final String RIOT_ROOT_URL = &quot;%s.api.riotgames.com&quot;;

    /** Retry-After header name. */
    private static final String HEADER_RETRY_AFTER = &quot;Retry-After&quot;;

    /** Responses representing success in the Riot API. Must be in ascending order. */
<span class="fc" id="L32">    private static final int[] STATUS_SUCCESS = {200, 204, 404, 422};</span>

    /** Ten seconds in milliseconds. */
    public static final long TEN_SECONDS = 10_000;
    /** Ten minutes in milliseconds. */

    public static final long TEN_MINUTES = 600_000;

    /** Number of times to retry when the request fails, but can still be retried (429, 50*, etc.). */
    private final int retries;

    /** Number of concurrent requests per region. */
    private final int concurrentRequestsMax;

    /** Listens to HTTP responses. Can be null. */
    private final Optional&lt;ResponseListener&gt; responseListener;

    /** Stores the rate limits to respect. Key is time in milliseconds, value is max requests per that time. */
<span class="fc" id="L50">    private final ConcurrentMap&lt;Long, Integer&gt; rateLimits = new ConcurrentHashMap&lt;&gt;();</span>
    /** Stores the RateLimiter for each Region. */
<span class="fc" id="L52">    private final ConcurrentMap&lt;Region, RateLimiter&gt; rateLimiters = new ConcurrentHashMap&lt;&gt;();</span>

    public RateLimitedRequester(String apiKey, Map&lt;Long, Integer&gt; rateLimits, AsyncHttpClient client, int retries,
            int concurrentRequestsMax, ResponseListener responseListener) {
<span class="fc" id="L56">        super(apiKey, client);</span>
<span class="fc" id="L57">        this.rateLimits.putAll(rateLimits);</span>
<span class="fc" id="L58">        this.retries = retries;</span>
<span class="fc" id="L59">        this.concurrentRequestsMax = concurrentRequestsMax;</span>
<span class="fc" id="L60">        this.responseListener = Optional.ofNullable(responseListener);</span>
<span class="fc" id="L61">    }</span>

    public CompletableFuture&lt;Response&gt; getRequestNonRateLimitedAsync(
            String relativeUrl, Region region, List&lt;Param&gt; params) {
<span class="nc" id="L65">        return getRequestAsync(String.format(RIOT_ROOT_URL, region.getSubdomain()), relativeUrl, params)</span>
<span class="nc" id="L66">                .toCompletableFuture()</span>
<span class="nc" id="L67">                .thenApply(r -&gt; {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                    if (Arrays.binarySearch(STATUS_SUCCESS, r.getStatusCode()) &gt;= 0) {</span>
<span class="nc" id="L69">                        responseListener.ifPresent(l -&gt; l.onResponse(true, r));</span>
<span class="nc" id="L70">                        return r;</span>
                    }
<span class="nc" id="L72">                    responseListener.ifPresent(l -&gt; l.onResponse(false, r));</span>
<span class="nc" id="L73">                    throw new RiotResponseException(</span>
<span class="nc" id="L74">                            String.format(&quot;Non rate limited request failed, no retries (%d). %s&quot;</span>
<span class="nc" id="L75">                                , r.getStatusCode(), r.getUri()), r);</span>
                });
    }

    public CompletableFuture&lt;Response&gt; getRequestRateLimitedAsync(
            String relativeUrl, Region region, List&lt;Param&gt; params) {
<span class="fc" id="L81">        return getRequestRateLimitedAsyncInternal(relativeUrl, region, 0, params);</span>
    }
    private CompletableFuture&lt;Response&gt; getRequestRateLimitedAsyncInternal(
            final String relativeUrl, final Region region, final int retryCount, final List&lt;Param&gt; params) {
<span class="fc" id="L85">        final RateLimiter limiter = getRateLimiter(region);</span>
<span class="fc" id="L86">        return limiter.acquireAsync()</span>
<span class="fc" id="L87">                .thenCompose(v -&gt; getRequestAsync(String.format(RIOT_ROOT_URL, region.getSubdomain()),</span>
                    relativeUrl, params))
<span class="fc" id="L89">                .whenComplete((r, e) -&gt; limiter.release()) // release limiter regardless of success or failure.</span>
<span class="fc" id="L90">                .thenCompose(r -&gt; {</span>
                    // if response was successful, return response
<span class="fc bfc" id="L92" title="All 2 branches covered.">                    if (Arrays.binarySearch(STATUS_SUCCESS, r.getStatusCode()) &gt;= 0) {</span>
<span class="pc" id="L93">                        responseListener.ifPresent(l -&gt; l.onResponse(true, r));</span>
<span class="fc" id="L94">                        return CompletableFuture.completedFuture(r);</span>
                    }
<span class="pc" id="L96">                    responseListener.ifPresent(l -&gt; l.onResponse(false, r));</span>
                    // if response has Retry-After header, set rateLimiter's retry after.
<span class="fc" id="L98">                    String retryAfter = r.getHeader(HEADER_RETRY_AFTER);</span>
                    //System.out.println(System.currentTimeMillis() + &quot; - RetryAfter: &quot; + retryAfter + &quot;, &quot; +
                    //        r.getHeader(&quot;X-Rate-Limit-Count&quot;));
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                    if (retryAfter != null)</span>
<span class="fc" id="L102">                        limiter.setRetryAfter(Long.parseLong(retryAfter) * 1000 + 50);</span>
                    // if the status code is not 429 and not a 5**, or if we are out of retries, throw an exception.
<span class="pc bpc" id="L104" title="6 of 8 branches missed.">                    if (r.getStatusCode() != 429 &amp;&amp; r.getStatusCode() != 400 &amp;&amp; r.getStatusCode() &lt; 500</span>
                            || retryCount &gt;= retries) {
<span class="nc" id="L106">                        throw new RiotResponseException(String.format(&quot;Async request failed after %d retries (%d).&quot;,</span>
<span class="nc" id="L107">                                retryCount, r.getStatusCode()), r);</span>
                    }
                    // otherwise retry request.
<span class="fc" id="L110">                    return getRequestRateLimitedAsyncInternal(relativeUrl, region, retryCount + 1, params);</span>
                });
    }

    /**
     * Gets a rate limiter from a region, creating it if needed.
     * @param region Region of rate limiter to get.
     * @return The rate limiter.
     */
    private RateLimiter getRateLimiter(Region region) {
<span class="fc bfc" id="L120" title="All 2 branches covered.">        return rateLimiters.compute(region, (k, v) -&gt; v == null ? new RateLimiter(rateLimits, concurrentRequestsMax) : v);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>